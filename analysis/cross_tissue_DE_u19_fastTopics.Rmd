---
title: "cross-tissue DE analysis with fastTopics"
output: html_document
date: "`r Sys.Date()`"
author: 'Jing Gu'
---
# GoM DE analysis on u19 dataset
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(poolr)
library(dplyr)
library(tidyr)
library(colorRamp2)
library(ComplexHeatmap)
set.seed(10)

# load data
counts<-readRDS("output/fastTopics/aggregated_lymph_scRNA_counts.RDS")
fit<-readRDS("output/fastTopics/fit_model_updates12_k150.RDS")
metadata<-readRDS("output/fastTopics/u19_cell_metadata.RDS")

# add sample covariates information
metadata$donor_id<-metadata$orig.ident
metadata$donor_id[metadata$full.ident=="spleens_2"]<-'3'
metadata$donor_id[metadata$full.ident=="spleens_3"]<-'6'
batch_ids<-c("batch1", "batch1", "batch2", "batch2", "batch3", "batch3", "batch1", "batch2", "batch3")
metadata$batch<-factor(metadata$full.ident, labels = batch_ids)
```
## Model fitting 

Parameters: 

N_updates = 150
N_topics = 12
## Model evaluation
```{r}
fit<-readRDS("output/fastTopics/fit_model_updates12_k150.RDS")
```

check the convergence
```{r}
# check for convergence of model fitting 
plot_progress(fit,x = "iter",add.point.every = 10,colors = "black") +
  theme_cowplot(font_size = 10)

summary(fit)
```

```{r}
loglik <- loglik_multinom_topic_model(counts,fit)
pdat <- data.frame(loglik)
ggplot(pdat,aes(loglik)) +
  geom_histogram(bins = 64,color = "white",fill = "black", linewidth = 0.25) +
  labs(y = "number of cells") +
  theme_cowplot(font_size = 10)

```

```{r}
pdat <- data.frame(loglik = loglik,subpop = metadata$majority_voting)
celltypes<-setdiff(unique(pdat$subpop),
                   c("ILC3", "Epithelial cells", "Plasma cells",
                     "Classical monocytes"))

ggplot(pdat %>% filter(subpop %in% celltypes),aes(x = loglik,fill = subpop)) +
  geom_histogram(bins = 64,color = "white",size = 0.25) +
  labs(y = "number of cells") +
  theme_cowplot(font_size = 10)
```

## Visualize topics with structural plots

* plot by tissue
```{r message=F}
structure_plot(fit,topics = 1:12,gap = 25,
               grouping = metadata$tissue.ident,
               verbose=FALSE) 
```
* plot by tissue and cell-type

```{r message=F}
ct_order <- 
  c("Naive_B",
    "Memory_B",
    "Monocytes",
    "ILC3",
    "CD4_T",
    "CD8_T",
    "Treg",
    "Th17",
    "NK",
    "Other"
  )
metadata$major <- factor(
  metadata$majority_voting,
  labels = c(
    "NK",
    "NK",
    "Monocytes",
    "Other",
    "ILC3",
    "Memory_B",
    "Naive_B",
    "Other",
    "Treg",
    "CD4_T",
    "CD8_T",
    "Th17"
  )
)
metadata$major <- factor(
  metadata$major,
  levels = ct_order
)
tissue_samples <-
  factor(
    paste(metadata$tissue.ident, metadata$major, sep = "_"),
    levels = c(paste("lungs",
                   ct_order,
                   sep = "_"),
               paste("spleens",
                     ct_order,
                     sep = "_")
    )
  )
# ordered_tissue_samples<-unlist(
#   lapply(unique(metadata$major), function(i){c(paste0("lungs_",  i),
#                                                paste0("spleens_", i)
#                                                )}))
# tissue_samples<-factor(tissue_samples,
#                        levels = ordered_tissue_samples)
structure_plot(fit,topics = 1:12,gap = 25,
               grouping = tissue_samples,
               verbose=FALSE
               ) 
```

## Characterize topics with enrichment analysis

Two ways to perform enrichment test:

* hypergeometric test (ORA from [WebGestaltR](https://cran.r-project.org/web/packages/WebGestaltR/WebGestaltR.pdf))

A test purely depends on occurrences, asking whether the genes related to a topic occur more frequently in GO term compared to the background genes.

* two-sample T test or regression ([MAGMA](https://cloufield.github.io/GWASTutorial/09_Gene_based_analysis/#annotate-snps))

It tests whether the genes in a set is more associated with **phenotype** than those outside of a set.

### GO enrichment results (ORA method) 

#### Top genes ranked by loadings
Input:  

- Top 500 loading genes vs. all genes 
- Database: Biological_Process, Cellular_Component, Molecular_Function

Top loading genes are enriched in large number of GO terms, which have broad functions.

```{r}
# set.seed(10)
# de <- de_analysis(fit,counts,pseudocount = 0.1,
#                   control = list(ns = 1e4,nc = 20))
# saveRDS(de, "output/fastTopics/GoM_DE_u19.RDS")
db <- c(#"pathway_KEGG", "disease_GLAD4U", "disease_OMIM",
                "Biological_Process", 
                "Cellular_Component",
                "Molecular_Function")

enrich_out<-readRDS("output/fastTopics/GO_enrichment_results_top500.RDS")
enrich_out<-data.frame(enrich_out, row.names = NULL)

DT::datatable(
  enrich_out %>% 
    mutate(k = factor(k, levels = paste0("k", 1:12))) %>%
    group_by(k) %>%
    dplyr::summarise(num_GOterms = n()) %>% 
    pivot_wider(names_from = k, values_from = num_GOterms),
  caption = "GO term counts"
)
```
```{r}
DT::datatable(
    enrich_out %>% 
      filter(database==sprintf("geneontology_%s_noRedundant", db[1])) %>%
      mutate(FDR=format(FDR, scientific=TRUE, digits=2),
             enrichment=format(enrichmentRatio, digits=2)) %>%
      select(c(k, description, enrichment, FDR)),
     caption=db[1])
```

```{r}
DT::datatable(
    enrich_out %>% 
      filter(database==sprintf("geneontology_%s_noRedundant", db[1])) %>%
      mutate(FDR=format(FDR, scientific=TRUE, digits=2),
             enrichment=format(enrichmentRatio, digits=2)) %>%
      select(c(k, description, enrichment, FDR)),
     caption=db[3])
```

#### Topic-specific genes through DE analysis

Input:   

- Up-regulated genes specific to each topic (z > 0 and lfsr < 0.01) vs. all genes 
- Database: Biological_Process, Cellular_Component, Molecular_Function

**Volcano plots for GoM DE results**

Axis: the z-scores for posterior mean log-fold change estimates vs. log-fold change

From volcano plots, we see several genes that encode different types of cytokines are present in topic 6. Chemokine ligands (CCL4, CCL20, etc.) are proteins that signal leukocyte migration, while cytokines (IL17A, IL22) are interleukins that signal immune cells to defend against pathogens.

```{r}
de<-readRDS("output/fastTopics/GoM_DE_u19.RDS")
de_list<-list()
for(k in 1:12){
  dat <- data.frame(postmean = de$postmean[,k],
                  z        = de$z[,k],
                  lfsr     = de$lfsr[,k])
  
  dat <- subset(dat,lfsr < 0.01)
  dat <- dat[order(dat$postmean,decreasing = TRUE),]
  de_list[[k]]<-dat
  print(volcano_plot(de, k=k, ymax=250,
  plot.title = sprintf("topic:%s", k)))
}
```
```{r}
# count how many DE genes identified in each topic
tbl<-unlist(lapply(de_list, function(i){sum(i$z >0)}))
names(tbl)<-paste0("t",1:12)
print("Number of up-regulated genes in each topic against the rest:")
tbl
```

**GO Enrichment result table**

All topics have fewer number of GO terms with enrichment, except for topic 1. 

```{r}
library(htmltools)
enrich_out<-readRDS("output/fastTopics/GO_enrichment_results_GoM_DE.RDS")
enrich_out<-data.frame(enrich_out, row.names = NULL)

DT::datatable(
  enrich_out %>% 
    mutate(k = factor(k, levels = paste0("k", 1:12))) %>%
    group_by(k) %>%
    dplyr::summarise(num_GOterms = n()) %>% 
    pivot_wider(names_from = k, values_from = num_GOterms),
  caption = "GO term counts"
)
```

```{r}
DT::datatable(
    enrich_out %>% 
      filter(database==sprintf("geneontology_%s_noRedundant", db[1])) %>%
      mutate(FDR=format(FDR, scientific=TRUE, digits=2),
             enrichment=format(enrichmentRatio, digits=2)) %>%
      select(c(k, description, enrichment, FDR)),
     caption=db[1])
```

```{r}
DT::datatable(
    enrich_out %>% 
      filter(database==sprintf("geneontology_%s_noRedundant", db[1])) %>%
      mutate(FDR=format(FDR, scientific=TRUE, digits=2),
             enrichment=format(enrichmentRatio, digits=2)) %>%
      select(c(k, description, enrichment, FDR)),
     caption=db[3])
```

**Visualizing GO enrichments with ComplexHeatmap**

Parameters:
- -log10(FDR) as value input
- No clustering due to missing data
- top 10 GO terms shown for each topic

Legend:
- Color scale capped by FDR = $10^{-15}$

BP results show k1 enriched for granulocyte activation and neutrophil mediated immunity, as well as cell adhesion and motility. These pathways are highly relevant to Asthma. Due to high number of GO terms over-represented by k1 genes, we may repeat the topic modeling by increasing topic number. Several topics like k2, 6, 7, 9, 10 are strongly enriched with protein localization. Topics k3-6 have genes over-represented in T-cell activation, while k10, 12 in B-cell activation.

MF results show broad enrichment of molecular binding, with k7 highly enriched for cell adhesion molecular binding. 

```{r fig.height = 12, fig.width = 10}
library(ComplexHeatmap)
#enrich_out<-readRDS("output/fastTopics/GO_enrichment_results_GoM_DE.RDS")

input_mat <-
  enrich_out %>% 
  select(k, description, database, FDR) %>% distinct() %>% 
  group_by(k, database) %>%
  mutate(FDR = -log10(FDR)) %>%
  top_n(10) 

for(i in db){
  mat <- 
    input_mat %>% 
    filter(grepl(i, database)) %>%
    pivot_wider(names_from = description,
                values_from = FDR) 
  terms<-mat$k
  mat<-as.matrix(mat[,-2:-1])
  rownames(mat)<-terms
  
  col_fun = colorRamp2(c(min(mat, na.rm = TRUE),
                         max(15, na.rm = TRUE)), 
                       c("white", "red"))
  #pdf(sprintf("../output/fastTopics/%s_GO_enrichment_by_topics_heatmap.pdf", i),
      #height = 15, width = 12)
  ht <- 
  Heatmap(
    t(mat),
    width=unit(10, "cm"),
    name = "-log10(FDR)",
    row_names_side = "left",
    cluster_rows = FALSE,
    cluster_columns = FALSE,
    na_col = "black",
    col = col_fun,
    column_title = sprintf("%s", i)
  )
  draw(ht)
  #dev.off()
}
```

## Identify topics correlated with tissue difference

1. We can test whether topic proportion is correlated with the tissue of origin
$$
F  = \beta X_{\text{tissue}} + \text{Covariates} + \epsilon
$$
2. perform T-test to see whether topic proportions between two tissues are significantly different

### Barplot for topic proportions in cell types

* The topic proportion between tissue are similar across T cell subsets.
* $CD8^+$ T cells have the highest proportion of k3 compared to others, similar as NK cells.
* The topic k1 dominates lung monocytes, and this topic separates ILC3 cells from other T/NK cells in lungs.
* The topic proportion that differs the most between tissue occurs in B cells(eg. k4, k10, k12)

```{r fig.width = 12, message=FALSE}
library(catecolors)

# convert poisson NMF model to multinational model
multinom_fit<-poisson2multinom(fit)
pdat<-data.frame(multinom_fit$L)
pdat$tissue<-metadata$tissue.ident
pdat$celltype<-metadata$major
pdat<-pdat %>% 
  pivot_longer(
    !c(tissue, celltype),
    names_to="topic", values_to="proportion")

# cell number by tissue and cell type
table(metadata$tissue.ident, metadata$major)

# Scaled to be added up to be 1
prop <-
  pdat %>%
  mutate(
    celltype =
      factor(celltype, levels = ct_order),
    topic = factor(topic, levels = paste0("k", 1:12))
  ) %>%
  group_by(tissue, celltype, topic) %>%
  dplyr::summarise(topic_prop = sum(proportion) / n())

ggplot(prop, aes(x = tissue, y = topic_prop, fill = topic)) +
  geom_bar(stat = "identity") + facet_grid(cols = vars(celltype)) + 
  xlab("") +  ylab("topic proportion") + 
  scale_fill_manual(values = kelly()[-1]) + 
  theme(axis.text.x = element_text(angle = 90)) 

```

## Perform t-test while adjusting for confounders


### Procedure

Test mean difference between tissue one donor at a time and then do meta-analysis with Fisher's method

### Results
X-axis denotes cell types and y-axis denotes the topics. For major cell types, we saw majority of topics have significant differences in proportions between tissue. 

```{r}
pdat<-data.frame(multinom_fit$L)
pdat$tissue<-metadata$tissue.ident
pdat$celltype<-metadata$major
pdat$donor_id<-metadata$donor_id
pdat<-pdat %>% 
  pivot_longer(
    !c(tissue, celltype, donor_id),
    names_to="topic", values_to="proportion")

celltypes<-setdiff(unique(pdat$celltype),
                    c("Treg", "Th17")
                    )
test_meandiff_by_celltype<-function(pdat){
  out_list<-list()
  for (j in setdiff(unique(pdat$celltype),
                    c("Treg", "Th17")
                    )){
    pdat_sub<-pdat %>% filter(celltype == j)
    out<-c()
    for(k in unique(pdat_sub$topic)){
      model<-t.test(pdat_sub %>% filter(tissue =="lungs" & topic == k) %>% 
                      select(proportion),
                    pdat_sub %>% filter(tissue =="spleens" & topic == k) %>% 
                      select(proportion))
      out<-rbind(out, c(k, model$estimate, model$p.value))
    }
    out<-data.frame(out)
    colnames(out)<-c("topic", "mean_lungs", "mean_spleens", "pval")
    out_list[[j]]<-out
  }
  return(out_list)
}
  
ranksum_test_by_celltype<-function(pdat){
  out_list<-list()
  for (j in setdiff(unique(pdat$celltype),
                    c("Treg", "Th17")
                    )){
    pdat_sub<-pdat %>% filter(celltype == j)
    out<-c()
    for(k in unique(pdat_sub$topic)){
      model <-
        wilcox.test(
          (pdat_sub %>% filter(tissue == "lungs" &
                                topic == k) %>% select(proportion))$proportion,
          (pdat_sub %>% filter(tissue == "spleens" &
                                topic == k) %>% select(proportion))$proportion
          
        )
      out<-rbind(out, c(k, model$p.value))
    }
    out<-data.frame(out)
    colnames(out)<-c("topic", "pval")
    out_list[[j]]<-out
  }
  return(out_list)
}

donor1<-test_meandiff_by_celltype(pdat%>%filter(donor_id=="1"))
donor2<-test_meandiff_by_celltype(pdat%>%filter(donor_id=="3"))
donor3<-test_meandiff_by_celltype(pdat%>%filter(donor_id=="6"))


combined_pvals<-list()
for(i in celltypes){
  combined_pvals[[i]]<-c()
  for(j in 1:length(unique(pdat$topic))){
    model<-fisher(
      as.numeric(
          donor1[[i]][j, "pval"],
          donor2[[i]][j, "pval"],
          donor3[[i]][j, "pval"])
      )
    combined_pvals[[i]]<-c(combined_pvals[[i]], model$p)
  }
}

```

```{r}
df<-do.call(rbind, combined_pvals)
colnames(df)<-paste0("k", 1:dim(df)[2])
col_fun_prop = colorRamp2(c(0, 0.05, 1), c("blue", "white", "red"))
plt <- Heatmap(df, col=col_fun_prop, 
               cluster_rows=FALSE,
               cluster_columns=FALSE,
               heatmap_legend_param = list(
                 col_fun=col_fun_prop, 
                 title="combined p-value",
                 at = c(0, 0.05, 1)
               ))
plt
```
### Find evidence for the function of TFs with motif enrichment in genes loaded on topic 5 
```{r}
check_tfs<-strsplit("JUND,FOS,JUNB,FOSL2,FOSL1,SMARCC1,RUNX1,JDP2,UNX2,STAT5A,LEF1,BACH1",",")[[1]]
topic5_genes<-de_list[[5]] %>% filter(z >0 & lfsr < 0.01)
grn<-list()
for(c in c("Treg", "CD8_T","CD4_T", "Th17")){
  f<-read.table(sprintf("data/lung_GRN_%s_edges.txt", c), 
                       sep=",", header =TRUE)
  tfs_in_grn<-f %>% filter(Regulator %in% check_tfs & Strength>0) %>% 
    select(Target)
  topic5_genes[, c]<-rownames(topic5_genes) %in% tfs_in_grn$Target
}

topic_in_grn<-topic5_genes %>% select(Treg, CD8_T, CD4_T, Th17) %>%
  pivot_longer(c(Treg, CD8_T, CD4_T, Th17), names_to="overlapped_set", values_to="count")

ggplot(topic_in_grn, aes(count, fill=overlapped_set)) + 
  stat_count(position="dodge") + 
  geom_text(aes(label=..count..), stat='count', vjust=0.2) + 
  facet_wrap(~overlapped_set)
```
```{r}
DT::datatable(topic5_genes %>% mutate(z=format(z, digits=2),
                                      lfsr=format(lfsr, digits=2)) %>%
                select(-postmean) %>%
                filter(Treg==TRUE|CD8_T==TRUE|CD4_T==TRUE|Th17==TRUE))
```



